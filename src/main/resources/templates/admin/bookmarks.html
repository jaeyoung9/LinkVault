<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>All Bookmarks - LinkVault Admin</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>
<div class="app-layout">
    <div th:replace="~{fragments/admin-layout :: sidebar}"></div>

    <div class="main-content">
        <div class="content-header">
            <h2>All Bookmarks</h2>
            <div style="display:flex;gap:8px;">
                <a href="/admin/bookmarks" class="btn btn-sm btn-outline" th:classappend="${showDeleted == null or !showDeleted} ? 'btn-active' : ''">Active</a>
                <a href="/admin/bookmarks?deleted=true" class="btn btn-sm btn-outline" th:classappend="${showDeleted != null and showDeleted} ? 'btn-active' : ''">Deleted</a>
            </div>
        </div>

        <table class="data-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>URL</th>
                <th>Owner</th>
                <th>Tags</th>
                <th>Folder</th>
                <th>Views</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="bookmark : ${bookmarks.content}">
                <td th:text="${bookmark.id}">1</td>
                <td>
                    <a th:href="@{'/bookmark/' + ${bookmark.id}}" th:text="${#strings.abbreviate(bookmark.title, 40)}">Title</a>
                    <span th:if="${bookmark.privatePost}" style="font-size:0.65rem;padding:1px 5px;border-radius:3px;background:var(--accent);color:#fff;margin-left:4px;">Private</span>
                </td>
                <td th:text="${#strings.abbreviate(bookmark.url, 40)}">https://...</td>
                <td th:text="${bookmark.ownerUsername}">admin</td>
                <td>
                    <span th:each="tag : ${bookmark.tagNames}" class="tag-badge" th:text="${tag}">tag</span>
                </td>
                <td th:text="${bookmark.folderName != null} ? ${bookmark.folderName} : '-'">-</td>
                <td th:text="${bookmark.accessCount}">0</td>
                <td th:text="${bookmark.createdAt != null} ? ${#temporals.format(bookmark.createdAt, 'yyyy-MM-dd')} : '-'">2024-01-01</td>
                <td th:if="${!bookmark.deleted}">
                    <button sec:authorize="hasAuthority('BOOKMARK_DELETE_ANY')" class="btn btn-sm btn-danger js-admin-delete-bookmark" th:data-id="${bookmark.id}">Del</button>
                </td>
                <td th:if="${bookmark.deleted}">
                    <button sec:authorize="hasAuthority('BOOKMARK_RESTORE')" class="btn btn-sm btn-outline js-restore-bookmark" th:data-id="${bookmark.id}">Restore</button>
                    <button sec:authorize="hasAuthority('CONTENT_PURGE')" class="btn btn-sm btn-danger js-purge-bookmark" th:data-id="${bookmark.id}">Purge</button>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <div th:if="${bookmarks != null}" th:replace="~{fragments/layout :: pagination(${bookmarks})}"></div>
    </div>
</div>

<script th:src="@{/js/admin.js}"></script>
<script>
document.querySelectorAll('.js-restore-bookmark').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var id = this.getAttribute('data-id');
        if (!confirm('Restore this bookmark?')) return;
        adminFetch('/api/admin/bookmarks/' + id + '/restore', { method: 'PATCH' })
            .then(function() { showToast('Bookmark restored'); location.reload(); })
            .catch(function(err) { showToast(err.message || 'Error restoring bookmark', 'error'); });
    });
});

document.querySelectorAll('.js-purge-bookmark').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var id = this.getAttribute('data-id');
        if (!confirm('Permanently delete this bookmark? This cannot be undone.')) return;
        adminFetch('/api/admin/bookmarks/' + id + '/purge', { method: 'DELETE' })
            .then(function() { showToast('Bookmark purged'); location.reload(); })
            .catch(function(err) { showToast(err.message || 'Error purging bookmark', 'error'); });
    });
});
</script>
</body>
</html>
