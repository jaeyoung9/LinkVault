<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Comment Moderation - LinkVault</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>
<div class="app-layout">
    <div th:replace="~{fragments/admin-layout :: sidebar}"></div>

    <div class="main-content">
        <div class="content-header">
            <h2>Comment Moderation</h2>
        </div>

        <table class="data-table" id="commentsTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Content</th>
                <th>Bookmark</th>
                <th>Likes</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="commentsBody">
            </tbody>
        </table>
    </div>
</div>

<script th:src="@{/js/admin.js}"></script>
<script>
var canDelete = [[${#authorization.expression('hasAuthority(''COMMENT_HIDE'')')}]];
var canRestore = [[${#authorization.expression('hasAuthority(''COMMENT_RESTORE'')')}]];
var canPurge = [[${#authorization.expression('hasAuthority(''CONTENT_PURGE'')')}]];

function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function loadComments() {
    adminFetch('/api/admin/comments')
        .then(function(comments) {
            var tbody = document.getElementById('commentsBody');
            tbody.innerHTML = '';
            comments.forEach(function(c) {
                var tr = document.createElement('tr');
                var content = c.content.length > 80 ? c.content.substring(0, 80) + '...' : c.content;

                var tdId = document.createElement('td');
                tdId.textContent = c.id;
                tr.appendChild(tdId);

                var tdUser = document.createElement('td');
                tdUser.textContent = c.username;
                tr.appendChild(tdUser);

                var tdContent = document.createElement('td');
                tdContent.style.cssText = 'max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';
                tdContent.textContent = content;
                tr.appendChild(tdContent);

                var tdBm = document.createElement('td');
                var bmLink = document.createElement('a');
                bmLink.href = '/bookmark/' + c.bookmarkId;
                bmLink.textContent = 'View';
                tdBm.appendChild(bmLink);
                tr.appendChild(tdBm);

                var tdLikes = document.createElement('td');
                tdLikes.textContent = c.likeCount + ' / ' + c.dislikeCount;
                tr.appendChild(tdLikes);

                var tdStatus = document.createElement('td');
                var statusSpan = document.createElement('span');
                statusSpan.className = 'badge ' + (c.deleted ? 'badge-danger' : (c.edited ? 'badge-warning' : 'badge-success'));
                statusSpan.textContent = c.deleted ? 'Deleted' : (c.edited ? 'Edited' : 'Active');
                tdStatus.appendChild(statusSpan);
                tr.appendChild(tdStatus);

                var tdDate = document.createElement('td');
                tdDate.textContent = c.createdAt ? c.createdAt.replace('T', ' ').substring(0, 16) : '-';
                tr.appendChild(tdDate);

                var tdActions = document.createElement('td');
                if (!c.deleted) {
                    if (canDelete) {
                        var delBtn = document.createElement('button');
                        delBtn.className = 'btn btn-sm btn-danger';
                        delBtn.textContent = 'Delete';
                        delBtn.addEventListener('click', function() { moderateDelete(c.id); });
                        tdActions.appendChild(delBtn);
                    }
                } else {
                    if (canRestore) {
                        var restoreBtn = document.createElement('button');
                        restoreBtn.className = 'btn btn-sm btn-outline';
                        restoreBtn.textContent = 'Restore';
                        restoreBtn.addEventListener('click', function() { restoreComment(c.id); });
                        tdActions.appendChild(restoreBtn);
                        tdActions.appendChild(document.createTextNode(' '));
                    }
                    if (canPurge) {
                        var purgeBtn = document.createElement('button');
                        purgeBtn.className = 'btn btn-sm btn-danger';
                        purgeBtn.textContent = 'Purge';
                        purgeBtn.addEventListener('click', function() { purgeComment(c.id); });
                        tdActions.appendChild(purgeBtn);
                    }
                }
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        })
        .catch(function(err) { showToast((err && err.message) || 'Error loading comments', 'error'); });
}

function moderateDelete(id) {
    if (!confirm('Soft-delete this comment?')) return;
    adminFetch('/api/admin/comments/' + id, { method: 'DELETE' })
        .then(function() { showToast('Comment deleted'); loadComments(); })
        .catch(function(err) { showToast(err.message || 'Error deleting comment', 'error'); });
}

function restoreComment(id) {
    if (!confirm('Restore this comment?')) return;
    adminFetch('/api/admin/comments/' + id + '/restore', { method: 'PATCH' })
        .then(function() { showToast('Comment restored'); loadComments(); })
        .catch(function(err) { showToast(err.message || 'Error restoring comment', 'error'); });
}

function purgeComment(id) {
    if (!confirm('Permanently delete this comment? This cannot be undone.')) return;
    adminFetch('/api/admin/comments/' + id + '/purge', { method: 'DELETE' })
        .then(function() { showToast('Comment permanently deleted'); loadComments(); })
        .catch(function(err) { showToast(err.message || 'Error purging comment', 'error'); });
}

document.addEventListener('DOMContentLoaded', loadComments);
</script>
</body>
</html>
