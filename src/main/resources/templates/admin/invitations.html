<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Invitation Codes - LinkVault</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>
<div class="app-layout">
    <div th:replace="~{fragments/admin-layout :: sidebar}"></div>

    <div class="main-content">
        <div class="content-header">
            <h2>Invitation Codes</h2>
            <button class="btn btn-primary" onclick="openInvModal()">+ Generate Code</button>
        </div>

        <table class="data-table" id="invTable">
            <thead>
            <tr>
                <th>Code</th>
                <th>Created By</th>
                <th>Uses</th>
                <th>Role</th>
                <th>Expires</th>
                <th>Note</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="invBody">
            </tbody>
        </table>
    </div>
</div>

<!-- Generate Code Modal -->
<div id="invModal" class="modal-overlay" onclick="if(event.target===this)closeInvModal()">
    <div class="modal">
        <h3>Generate Invitation Code</h3>
        <form id="invForm" onsubmit="generateCode(event)">
            <div class="form-group">
                <label for="invMaxUses">Max Uses</label>
                <input type="number" id="invMaxUses" class="form-control" value="1" min="1"/>
            </div>
            <div class="form-group">
                <label for="invExpiry">Expires In (hours, 0 = never)</label>
                <input type="number" id="invExpiry" class="form-control" value="0" min="0"/>
            </div>
            <div class="form-group">
                <label for="invRole">Assigned Role</label>
                <select id="invRole" class="form-control">
                    <option value="MEMBER">MEMBER</option>
                    <option value="MODERATOR">MODERATOR</option>
                    <option value="COMMUNITY_ADMIN">COMMUNITY_ADMIN</option>
                </select>
            </div>
            <div class="form-group">
                <label for="invNote">Note</label>
                <input type="text" id="invNote" class="form-control" placeholder="Optional note"/>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-outline" onclick="closeInvModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Generate</button>
            </div>
        </form>
    </div>
</div>

<script th:src="@{/js/admin.js}"></script>
<script>
function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function loadInvitations() {
    adminFetch('/api/admin/invitations')
        .then(function(codes) {
            var tbody = document.getElementById('invBody');
            tbody.innerHTML = '';
            codes.forEach(function(c) {
                var tr = document.createElement('tr');

                var tdCode = document.createElement('td');
                var codeEl = document.createElement('code');
                codeEl.style.cssText = 'background:var(--bg-card);padding:2px 8px;border-radius:4px;cursor:pointer;';
                codeEl.textContent = c.code;
                codeEl.addEventListener('click', function() { copyCode(c.code); });
                tdCode.appendChild(codeEl);
                tr.appendChild(tdCode);

                var tdCreator = document.createElement('td');
                tdCreator.textContent = c.createdByUsername || '-';
                tr.appendChild(tdCreator);

                var tdUses = document.createElement('td');
                tdUses.textContent = c.currentUses + ' / ' + (c.maxUses > 0 ? c.maxUses : 'unlimited');
                tr.appendChild(tdUses);

                var tdRole = document.createElement('td');
                var roleSpan = document.createElement('span');
                roleSpan.className = 'badge badge-info';
                roleSpan.textContent = c.assignedRole || 'MEMBER';
                tdRole.appendChild(roleSpan);
                tr.appendChild(tdRole);

                var tdExpiry = document.createElement('td');
                tdExpiry.textContent = c.expiresAt ? c.expiresAt.replace('T', ' ').substring(0, 16) : 'Never';
                tr.appendChild(tdExpiry);

                var tdNote = document.createElement('td');
                tdNote.style.fontSize = '0.78rem';
                tdNote.textContent = c.note || '-';
                tr.appendChild(tdNote);

                var tdStatus = document.createElement('td');
                var statusSpan = document.createElement('span');
                statusSpan.className = 'badge ' + (c.usable ? 'badge-success' : 'badge-danger');
                statusSpan.textContent = c.usable ? 'Usable' : (c.active ? 'Expired/Full' : 'Inactive');
                tdStatus.appendChild(statusSpan);
                tr.appendChild(tdStatus);

                var tdActions = document.createElement('td');
                var toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-sm btn-outline';
                toggleBtn.textContent = c.active ? 'Deactivate' : 'Activate';
                toggleBtn.addEventListener('click', function() { toggleInv(c.id); });
                tdActions.appendChild(toggleBtn);
                tdActions.appendChild(document.createTextNode(' '));
                var delBtn = document.createElement('button');
                delBtn.className = 'btn btn-sm btn-danger';
                delBtn.textContent = 'Del';
                delBtn.addEventListener('click', function() { deleteInv(c.id); });
                tdActions.appendChild(delBtn);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        })
        .catch(function(err) { showToast((err && err.message) || 'Error loading invitations', 'error'); });
}

function openInvModal() { document.getElementById('invModal').classList.add('active'); }
function closeInvModal() { document.getElementById('invModal').classList.remove('active'); }

function generateCode(event) {
    event.preventDefault();
    var data = {
        maxUses: parseInt(document.getElementById('invMaxUses').value) || 1,
        expiresInHours: parseInt(document.getElementById('invExpiry').value) || null,
        assignedRole: document.getElementById('invRole').value,
        note: document.getElementById('invNote').value || null
    };

    adminFetch('/api/admin/invitations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(function(result) {
        closeInvModal();
        showToast('Code generated: ' + (result ? result.code : ''));
        loadInvitations();
    })
    .catch(function(err) { showToast(err.message || 'Error generating code', 'error'); });
}

function copyCode(code) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(code).then(function() {
            showToast('Code copied: ' + code);
        }).catch(function() {
            showToast('Failed to copy code to clipboard', 'error');
        });
    } else {
        var ta = document.createElement('textarea');
        ta.value = code;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        try {
            document.execCommand('copy');
            showToast('Code copied: ' + code);
        } catch (e) {
            showToast('Failed to copy code to clipboard', 'error');
        }
        document.body.removeChild(ta);
    }
}

function toggleInv(id) {
    adminFetch('/api/admin/invitations/' + id + '/toggle', { method: 'PATCH' })
        .then(function() { showToast('Invitation toggled'); loadInvitations(); })
        .catch(function(err) { showToast(err.message || 'Error toggling invitation', 'error'); });
}

function deleteInv(id) {
    if (!confirm('Delete this invitation code?')) return;
    adminFetch('/api/admin/invitations/' + id, { method: 'DELETE' })
        .then(function() { showToast('Invitation deleted'); loadInvitations(); })
        .catch(function(err) { showToast(err.message || 'Error deleting invitation', 'error'); });
}

document.addEventListener('DOMContentLoaded', loadInvitations);
</script>
</body>
</html>
