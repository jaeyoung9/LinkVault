<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Settings - Admin - LinkVault</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>
<div class="app-layout">
    <div th:replace="~{fragments/admin-layout :: sidebar}"></div>

    <div class="main-content">
        <div class="content-header">
            <h2>System Settings</h2>
        </div>

        <div class="alert" style="background:var(--surface-hover);border:1px solid var(--border);border-radius:8px;padding:12px 16px;margin-bottom:20px;color:var(--text-muted);font-size:0.85rem;">
            Note: Settings are stored in H2 in-memory database and will reset to defaults on server restart.
        </div>

        <div id="settingsContainer">
            <div style="text-align:center;padding:40px;color:var(--text-muted);">Loading settings...</div>
        </div>
    </div>
</div>

<script th:src="@{/js/admin.js}"></script>
<script>
function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

var AUDIT_HINTS = {
    'audit.retention.enabled': { type: 'select', options: ['true', 'false'] },
    'audit.retention.days': { type: 'number', min: 30, max: 3650, hint: '30 ~ 3650' },
    'audit.delete.mode': { type: 'select', options: ['SOFT', 'HARD'] },
    'audit.masking.level': { type: 'select', options: ['NONE', 'BASIC', 'STRICT'] },
    'feature.guest-access-enabled': { type: 'select', options: ['true', 'false'] },
    'feature.ads-enabled': { type: 'select', options: ['true', 'false'] },
    'feature.rewarded-video-enabled': { type: 'select', options: ['true', 'false'] },
    'feature.donations-enabled': { type: 'select', options: ['true', 'false'] },
    'ad.max-per-page': { type: 'number', min: 0, max: 20, hint: '0 ~ 20' },
    'ad.max-per-session': { type: 'number', min: 0, max: 100, hint: '0 ~ 100' },
    'ad.max-per-hour': { type: 'number', min: 0, max: 100, hint: '0 ~ 100' },
    'ad.feed-insertion-interval': { type: 'number', min: 1, max: 50, hint: '1 ~ 50' },
    'ad.guest-first-session-grace': { type: 'number', min: 0, max: 20, hint: '0 ~ 20' },
    'reward.video-points': { type: 'number', min: 1, max: 100, hint: '1 ~ 100' },
    'reward.adfree-hours-cost': { type: 'number', min: 1, max: 500, hint: '1 ~ 500' },
    'reward.adfree-hours-duration': { type: 'number', min: 1, max: 48, hint: '1 ~ 48' },
    'reward.daily-video-cap': { type: 'number', min: 1, max: 50, hint: '1 ~ 50' }
};

var CATEGORY_LABELS = {
    'FEATURE_FLAGS': 'Feature Flags',
    'AD_POLICY': 'Ad Policy',
    'REWARD': 'Reward Settings',
    'STRIPE': 'Stripe Payment',
    'DONATION': 'Donation Settings',
    'AUDIT_POLICY': 'Audit Policy',
    'FILE_STORAGE': 'File Storage',
    'MODERATION': 'Moderation',
    'GENERAL': 'General'
};

var CATEGORY_ORDER = ['FEATURE_FLAGS', 'AD_POLICY', 'REWARD', 'STRIPE', 'DONATION', 'AUDIT_POLICY', 'FILE_STORAGE', 'MODERATION', 'GENERAL'];

function loadSettings() {
    adminFetch('/api/admin/settings')
        .then(function(settings) {
            var container = document.getElementById('settingsContainer');
            if (!settings || settings.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No settings found</div>';
                return;
            }

            var categories = {};
            settings.forEach(function(s) {
                var cat = s.category || 'GENERAL';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(s);
            });

            var sortedKeys = Object.keys(categories).sort(function(a, b) {
                var ai = CATEGORY_ORDER.indexOf(a);
                var bi = CATEGORY_ORDER.indexOf(b);
                if (ai === -1) ai = 999;
                if (bi === -1) bi = 999;
                return ai - bi;
            });

            container.innerHTML = '';

            sortedKeys.forEach(function(cat) {
                var card = document.createElement('div');
                card.className = 'card';
                card.style.cssText = 'margin-bottom:20px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px;';

                var heading = document.createElement('h3');
                heading.style.cssText = 'margin:0 0 16px 0;font-size:1rem;color:var(--text-primary);';
                heading.textContent = CATEGORY_LABELS[cat] || cat.replace(/_/g, ' ');
                card.appendChild(heading);

                categories[cat].forEach(function(s) {
                    var row = document.createElement('div');
                    row.style.cssText = 'margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);';

                    var label = document.createElement('label');
                    label.style.cssText = 'display:block;margin-bottom:4px;font-weight:500;color:var(--text-primary);font-size:0.9rem;';
                    label.textContent = s.description;
                    row.appendChild(label);

                    var keyDiv = document.createElement('div');
                    keyDiv.style.cssText = 'font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;';
                    keyDiv.textContent = s.settingKey;
                    row.appendChild(keyDiv);

                    var inputRow = document.createElement('div');
                    inputRow.style.cssText = 'display:flex;gap:8px;align-items:center;';

                    var hint = AUDIT_HINTS[s.settingKey];
                    var inputEl;

                    if (hint && hint.type === 'select') {
                        inputEl = document.createElement('select');
                        inputEl.id = 'setting-' + s.settingKey;
                        inputEl.className = 'form-control';
                        inputEl.style.flex = '1';
                        hint.options.forEach(function(opt) {
                            var option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            if (opt === s.settingValue) option.selected = true;
                            inputEl.appendChild(option);
                        });
                    } else {
                        inputEl = document.createElement('input');
                        inputEl.type = (hint && hint.type === 'number') ? 'number' : 'text';
                        inputEl.id = 'setting-' + s.settingKey;
                        inputEl.className = 'form-control';
                        inputEl.value = s.settingValue || '';
                        inputEl.style.flex = '1';
                        if (hint && hint.min !== undefined) inputEl.min = hint.min;
                        if (hint && hint.max !== undefined) inputEl.max = hint.max;
                    }
                    inputRow.appendChild(inputEl);

                    if (hint && hint.hint) {
                        var hintSpan = document.createElement('span');
                        hintSpan.style.cssText = 'font-size:0.7rem;color:var(--text-muted);white-space:nowrap;';
                        hintSpan.textContent = hint.hint;
                        inputRow.appendChild(hintSpan);
                    }

                    var saveBtn = document.createElement('button');
                    saveBtn.className = 'btn btn-primary btn-sm';
                    saveBtn.textContent = 'Save';
                    saveBtn.setAttribute('data-key', s.settingKey);
                    saveBtn.addEventListener('click', function() {
                        saveSetting(this.getAttribute('data-key'));
                    });
                    inputRow.appendChild(saveBtn);

                    row.appendChild(inputRow);

                    if (s.updatedAt) {
                        var updated = document.createElement('div');
                        updated.style.cssText = 'font-size:0.7rem;color:var(--text-muted);margin-top:4px;';
                        updated.textContent = 'Last updated: ' + s.updatedAt.substring(0, 19).replace('T', ' ');
                        row.appendChild(updated);
                    }

                    card.appendChild(row);
                });

                container.appendChild(card);
            });
        })
        .catch(function(err) {
            var msg = (err && err.message) || 'Error loading settings';
            if (err && err.status === 403) msg = 'Insufficient permission';
            document.getElementById('settingsContainer').innerHTML =
                '<div style="text-align:center;padding:40px;color:var(--danger);">' + escapeHtml(msg) + '</div>';
        });
}

function saveSetting(key) {
    var input = document.getElementById('setting-' + key);
    if (!input) return;
    var value = input.value;

    adminFetch('/api/admin/settings/' + encodeURIComponent(key), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ value: value })
    })
    .then(function(result) {
        var msg = result && result.settingKey ? 'Saved: ' + result.settingKey : 'Setting updated';
        showToast(msg);
    })
    .catch(function(err) {
        var msg = (err && err.message) || 'Error saving setting';
        if (err && err.status === 403) msg = 'Insufficient permission';
        showToast(msg, 'error');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});
</script>
</body>
</html>
