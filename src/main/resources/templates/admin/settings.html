<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Settings - Admin - LinkVault</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>
<div class="app-layout">
    <div th:replace="~{fragments/admin-layout :: sidebar}"></div>

    <div class="main-content">
        <div class="content-header">
            <h2>System Settings</h2>
        </div>

        <div class="alert" style="background:var(--surface-hover);border:1px solid var(--border);border-radius:8px;padding:12px 16px;margin-bottom:20px;color:var(--text-muted);font-size:0.85rem;">
            Note: Settings are stored in H2 in-memory database and will reset to defaults on server restart.
        </div>

        <div id="settingsContainer">
            <div style="text-align:center;padding:40px;color:var(--text-muted);">Loading settings...</div>
        </div>
    </div>
</div>

<script th:src="@{/js/admin.js}"></script>
<script>
function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function loadSettings() {
    adminFetch('/api/admin/settings')
        .then(function(settings) {
            var container = document.getElementById('settingsContainer');
            if (!settings || settings.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No settings found</div>';
                return;
            }

            // Group by category
            var categories = {};
            settings.forEach(function(s) {
                var cat = s.category || 'GENERAL';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(s);
            });

            var html = '';
            Object.keys(categories).sort().forEach(function(cat) {
                html += '<div class="card" style="margin-bottom:20px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px;">';
                html += '<h3 style="margin:0 0 16px 0;font-size:1rem;color:var(--text-primary);">' + escapeHtml(cat.replace(/_/g, ' ')) + '</h3>';

                categories[cat].forEach(function(s) {
                    html += '<div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);">';
                    html += '<label style="display:block;margin-bottom:4px;font-weight:500;color:var(--text-primary);font-size:0.9rem;">' + escapeHtml(s.description) + '</label>';
                    html += '<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">' + escapeHtml(s.settingKey) + '</div>';
                    html += '<div style="display:flex;gap:8px;align-items:center;">';
                    html += '<input type="text" id="setting-' + escapeHtml(s.settingKey) + '" class="form-control" value="' + escapeHtml(s.settingValue) + '" style="flex:1;"/>';
                    html += '<button class="btn btn-primary btn-sm" onclick="saveSetting(\'' + escapeHtml(s.settingKey) + '\')">Save</button>';
                    html += '</div>';
                    if (s.updatedAt) {
                        html += '<div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px;">Last updated: ' + s.updatedAt.substring(0, 19).replace('T', ' ') + '</div>';
                    }
                    html += '</div>';
                });

                html += '</div>';
            });

            container.innerHTML = html;
        })
        .catch(function(err) {
            var msg = (err && err.message) || 'Error loading settings';
            document.getElementById('settingsContainer').innerHTML =
                '<div style="text-align:center;padding:40px;color:var(--danger);">' + msg + '</div>';
        });
}

function saveSetting(key) {
    var input = document.getElementById('setting-' + key);
    if (!input) return;
    var value = input.value;

    adminFetch('/api/admin/settings/' + encodeURIComponent(key), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ value: value })
    })
    .then(function() {
        showToast('Setting updated: ' + key);
    })
    .catch(function(err) {
        showToast(err.message || 'Error saving setting', 'error');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});
</script>
</body>
</html>
