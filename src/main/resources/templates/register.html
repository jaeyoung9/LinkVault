<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Register - LinkVault</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body class="login-body">
<div class="login-container">
    <div class="login-card">
        <h1 style="color: var(--accent); margin-bottom: 4px;">LinkVault</h1>
        <p class="login-subtitle">Create your account</p>

        <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>
        <div id="successAlert" class="alert alert-success" style="display: none;"></div>

        <form id="registerForm" onsubmit="handleRegister(event)" style="margin-top: 20px;">
            <div class="form-group">
                <label for="invCode">Invitation Code *</label>
                <input type="text" id="invCode" class="form-control" placeholder="Enter invitation code" required/>
                <div id="codeStatus" style="font-size: 0.78rem; margin-top: 4px;"></div>
            </div>
            <div class="form-group">
                <label for="regUsername">Username *</label>
                <input type="text" id="regUsername" class="form-control" placeholder="Choose a username" required minlength="3"/>
            </div>
            <div class="form-group">
                <label for="regEmail">Email *</label>
                <input type="email" id="regEmail" class="form-control" placeholder="your@email.com" required/>
            </div>
            <div class="form-group">
                <label for="regPassword">Password *</label>
                <input type="password" id="regPassword" class="form-control" placeholder="Min 6 characters" required minlength="6"/>
            </div>
            <div class="form-group" style="margin-top: 12px;">
                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                    <button type="button" id="privacyToggle" onclick="togglePrivacy()"
                            style="width: 100%; background: var(--bg-card); border: none; padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-primary); font-size: 0.85rem; font-weight: 600;">
                        <span>Privacy Policy <span th:if="${privacyPolicyVersion != null}" th:text="'(v' + ${privacyPolicyVersion} + ')'" style="font-weight: normal; font-size: 0.78rem; color: var(--text-secondary);"></span></span>
                        <span id="privacyArrow" style="transition: transform 0.2s;">&#9660;</span>
                    </button>
                    <div id="privacyContent" style="display: none; padding: 14px; font-size: 0.78rem; color: var(--text-secondary); max-height: 260px; overflow-y: auto; border-top: 1px solid var(--border); line-height: 1.6;"
                         th:utext="${privacyPolicyContent} ?: 'No privacy policy has been configured yet.'"></div>
                </div>
                <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 0.82rem; cursor: pointer;">
                    <input type="checkbox" id="privacyAgree" required/>
                    I have read and agree to the Privacy Policy
                </label>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Register</button>
        </form>

        <p style="text-align: center; margin-top: 16px; font-size: 0.85rem;">
            Already have an account? <a href="/login">Sign In</a>
        </p>
    </div>
</div>

<script>
// Real-time code validation on blur
document.getElementById('invCode').addEventListener('blur', function() {
    var code = this.value.trim();
    var status = document.getElementById('codeStatus');
    if (!code) { status.textContent = ''; return; }

    fetch('/api/auth/validate-code?code=' + encodeURIComponent(code))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.valid) {
                status.textContent = 'Valid code (role: ' + data.assignedRole + ')';
                status.style.color = 'var(--success)';
            } else {
                status.textContent = data.message || 'Invalid code';
                status.style.color = 'var(--danger)';
            }
        })
        .catch(function() {
            status.textContent = 'Error validating code';
            status.style.color = 'var(--danger)';
        });
});

function togglePrivacy() {
    var content = document.getElementById('privacyContent');
    var arrow = document.getElementById('privacyArrow');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

function handleRegister(event) {
    event.preventDefault();
    var errorEl = document.getElementById('errorAlert');
    var successEl = document.getElementById('successAlert');
    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    var data = {
        username: document.getElementById('regUsername').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPassword').value,
        invitationCode: document.getElementById('invCode').value
    };

    fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(function(r) {
        if (!r.ok) return r.json().then(function(e) { throw e; });
        return r.json();
    })
    .then(function(result) {
        successEl.textContent = result.message || 'Registration successful!';
        successEl.style.display = '';
        setTimeout(function() { window.location.href = '/login'; }, 2000);
    })
    .catch(function(err) {
        errorEl.textContent = err.message || 'Registration failed';
        errorEl.style.display = '';
    });
}
</script>
</body>
</html>
