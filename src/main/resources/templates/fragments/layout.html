<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<!-- Sidebar Fragment (includes mobile hamburger + notification panel) -->
<th:block th:fragment="sidebar">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<script th:inline="javascript">
(function(){var t=/*[[${currentTheme}]]*/'DARK';if(t==='LIGHT')document.body.classList.add('light-theme');else document.body.classList.remove('light-theme');localStorage.setItem('theme',t);})();
</script>
<button id="mobileMenuBtn" class="mobile-menu-btn" onclick="toggleMobileSidebar()">&#9776;</button>
<div id="mobileOverlay" class="mobile-overlay" onclick="toggleMobileSidebar()"></div>

<div class="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-header-top">
            <div class="sidebar-brand">
                <h1>LinkVault</h1>
                <p class="sidebar-brand-sub">Share Places &amp; Stories</p>
            </div>
            <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar">&#9776;</button>
        </div>
        <p class="sidebar-username" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;"
           sec:authentication="name">user</p>

        <!-- Sidebar header icons: Search + Notifications -->
        <div class="sidebar-header-icons">
            <button class="sidebar-icon-btn" onclick="openSearchModal()" title="Search (Ctrl+K)">
                &#128269; <span class="sidebar-icon-label">Ctrl+K</span>
            </button>
            <button class="sidebar-icon-btn notification-bell-btn" onclick="toggleNotificationPanel()" title="Notifications">
                &#128276;
                <span class="notification-badge" th:if="${unreadNotificationCount != null and unreadNotificationCount > 0}"
                      th:text="${unreadNotificationCount}">0</span>
            </button>
        </div>
    </div>

    <!-- Favorites Section -->
    <div class="sidebar-section favorites-section" th:if="${favorites != null and !favorites.isEmpty()}">
        <h3>&#9733; Favorites</h3>
        <div id="favoritesContainer">
            <div th:each="fav : ${favorites}" class="favorite-item" draggable="true"
                 th:data-bookmark-id="${fav.bookmarkId}">
                <a th:href="@{'/bookmark/' + ${fav.bookmarkId}}" class="sidebar-link">
                    <img th:if="${fav.bookmarkFavicon != null and !fav.bookmarkFavicon.isEmpty()}"
                         th:src="${fav.bookmarkFavicon}" style="width:16px;height:16px;border-radius:3px;" alt=""
                         onerror="this.style.display='none'"/>
                    <span class="sidebar-link-text" th:text="${fav.bookmarkTitle}">Favorite</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Dynamic Menu Items -->
    <div class="sidebar-section" th:if="${sidebarMenuItems != null and !sidebarMenuItems.isEmpty()}">
        <th:block th:each="item : ${sidebarMenuItems}">
            <div th:replace="~{fragments/layout :: menuItem(${item})}"></div>
        </th:block>
    </div>

    <div class="sidebar-section">
        <h3>Folders</h3>
        <div id="uncategorizedDrop">
            <a href="/" class="sidebar-link">
                <span class="sidebar-link-text">Unsorted</span>
            </a>
        </div>
        <th:block th:each="folder : ${folders}">
            <div th:replace="~{fragments/layout :: folderTree(${folder})}"></div>
        </th:block>
        <a href="javascript:void(0)" onclick="openFolderModal()" class="sidebar-link" style="color: var(--accent);">
            <span class="sidebar-link-text">+ New Folder</span>
        </a>
    </div>

    <div class="sidebar-section">
        <h3>Tags</h3>
        <div class="sidebar-tags-wrap" style="display: flex; flex-wrap: wrap; gap: 4px; padding: 4px 0;">
            <a th:each="tag : ${tags}" th:href="@{'/tag/' + ${tag.name}}" class="tag-badge">
                <span th:text="${tag.name}">tag</span>
                <span class="tag-count" th:text="${tag.bookmarkCount}">0</span>
            </a>
        </div>
    </div>

    <div class="sidebar-section" style="margin-top: auto; border-top: 1px solid var(--border); padding-top: 12px;">
        <a href="/qna" class="sidebar-link">
            <span class="sidebar-link-text">QnA Guide</span>
            <span class="sidebar-badge-dot" th:if="${qnaHasRecentUpdate}"></span>
        </a>
        <a href="/announcements" class="sidebar-link" style="position: relative;">
            <span class="sidebar-link-text">Announcements</span>
            <span class="sidebar-announcement-badge" th:if="${unreadAnnouncementCount != null and unreadAnnouncementCount > 0}"
                  th:text="${unreadAnnouncementCount}">0</span>
        </a>
        <a href="/settings" class="sidebar-link"><span class="sidebar-link-text">Settings</span></a>
        <form th:action="@{/logout}" method="post" style="margin: 0;">
            <button type="submit" class="sidebar-link" style="background: none; border: none; width: 100%; text-align: left; cursor: pointer; color: var(--text-secondary); font-size: 0.875rem; padding: 6px 12px;">
                <span class="sidebar-link-text">Logout</span>
            </button>
        </form>
    </div>
</div>

<!-- Notification Panel (fixed position, outside sidebar to avoid overflow clipping) -->
<div id="notificationPanel" class="notification-panel" style="display: none;">
    <div class="notification-panel-header">
        <strong>Notifications</strong>
        <button class="comment-action-btn" onclick="markAllNotificationsRead()">Mark all read</button>
    </div>
    <div id="notificationList" class="notification-list">
        <div class="empty-state" style="padding: 20px;">
            <p style="font-size: 0.82rem;">No notifications</p>
        </div>
    </div>
</div>
</th:block>

<!-- Dynamic Menu Item Fragment (recursive) -->
<div th:fragment="menuItem(item)">
    <a th:href="${item.url}" class="sidebar-link"
       th:style="${item.url.startsWith('/admin')} ? 'color: var(--warning);' : ''">
        <span class="sidebar-link-text" th:text="${item.label}">Menu Item</span>
    </a>
    <div class="menu-children" th:if="${item.children != null and !item.children.isEmpty()}">
        <th:block th:each="child : ${item.children}">
            <div th:replace="~{fragments/layout :: menuItem(${child})}"></div>
        </th:block>
    </div>
</div>

<!-- Recursive Folder Tree Fragment -->
<div th:fragment="folderTree(folder)">
    <div class="folder-item" th:data-folder-id="${folder.id}" draggable="false">
        <a th:href="@{'/folder/' + ${folder.id}}" class="sidebar-link">
            <span class="sidebar-link-text" th:text="${folder.name}">Folder</span>
            <span class="tag-count" th:text="${folder.bookmarkCount}">0</span>
        </a>
        <div class="folder-children" th:if="${folder.children != null and !folder.children.isEmpty()}">
            <th:block th:each="child : ${folder.children}">
                <div th:replace="~{fragments/layout :: folderTree(${child})}"></div>
            </th:block>
        </div>
    </div>
</div>

<!-- Post Card Fragment (photo-first) -->
<div th:fragment="postCard(bookmark)" class="post-card" th:data-id="${bookmark.id}">
    <div class="post-card-img post-card-img-placeholder" th:if="${bookmark.leadPhotoUrl != null}">
        <img th:src="${bookmark.leadPhotoUrl}" alt="" loading="lazy"/>
    </div>
    <div class="post-card-img post-card-img-placeholder" th:if="${bookmark.leadPhotoUrl == null}">
        <span>&#128247;</span>
    </div>
    <div class="post-card-body">
        <a th:href="@{'/bookmark/' + ${bookmark.id}}" class="post-card-title" th:text="${bookmark.title}">Title</a>
        <span th:if="${bookmark.privatePost}" class="badge badge-info" style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:var(--accent);color:#fff;">Private</span>
        <div class="post-card-location" th:if="${bookmark.address != null and !bookmark.address.isEmpty()}">
            <span>&#128205;</span> <span th:text="${bookmark.address}">Location</span>
        </div>
        <div class="post-card-caption" th:if="${bookmark.caption != null and !bookmark.caption.isEmpty()}"
             th:text="${bookmark.caption}">Caption snippet</div>
        <div class="post-card-meta">
            <span th:if="${bookmark.ownerUsername != null}" th:text="'by ' + ${bookmark.ownerUsername}"></span>
            <a th:href="@{'/bookmark/' + ${bookmark.id}}"
               style="color: var(--text-muted); text-decoration: none;"
               th:text="${bookmark.commentCount != null and bookmark.commentCount > 0} ? ${bookmark.commentCount} + ' comments' : 'Comment'">Comment</a>
            <span th:text="'Views: ' + ${bookmark.accessCount}">Views: 0</span>
        </div>
        <div class="post-card-tags" th:if="${bookmark.tagNames != null and !bookmark.tagNames.isEmpty()}">
            <a th:each="tag : ${bookmark.tagNames}" th:href="@{'/tag/' + ${tag}}" class="tag-badge" th:text="${tag}">tag</a>
        </div>
    </div>
</div>

<!-- Bookmark Card Fragment (legacy, still used in some views) -->
<div th:fragment="bookmarkCard(bookmark)" class="bookmark-card" draggable="true"
     th:data-id="${bookmark.id}" th:data-url="${bookmark.url}">
    <div class="bookmark-header">
        <img th:if="${bookmark.favicon != null and !bookmark.favicon.isEmpty()}"
             th:src="${bookmark.favicon}" class="bookmark-favicon" alt=""
             onerror="this.style.display='none'"/>
        <a href="javascript:void(0)" class="bookmark-title js-access-link"
           th:data-id="${bookmark.id}" th:data-url="${bookmark.url}"
           th:text="${bookmark.title}">Title</a>
        <div class="bookmark-card-actions">
            <button class="bookmark-icon-btn js-save-btn" th:data-id="${bookmark.id}" title="Save for later">&#128278;</button>
            <button class="bookmark-icon-btn js-fav-btn" th:data-id="${bookmark.id}" title="Add to favorites">&#9734;</button>
        </div>
        <div class="bookmark-actions"
             th:if="${bookmark.ownerUsername == currentUser}"
             sec:authorize="isAuthenticated()">
            <button class="btn btn-sm btn-outline js-edit-btn" th:data-id="${bookmark.id}">Edit</button>
            <button class="btn btn-sm btn-danger js-delete-btn" th:data-id="${bookmark.id}">Del</button>
        </div>
        <div class="bookmark-actions"
             th:if="${bookmark.ownerUsername != currentUser}"
             sec:authorize="hasAnyRole('SUPER_ADMIN','COMMUNITY_ADMIN')">
            <button class="btn btn-sm btn-outline js-edit-btn" th:data-id="${bookmark.id}">Edit</button>
            <button class="btn btn-sm btn-danger js-delete-btn" th:data-id="${bookmark.id}">Del</button>
        </div>
    </div>
    <div class="bookmark-url" th:if="${bookmark.url != null}" th:text="${bookmark.url}">https://example.com</div>
    <div class="bookmark-desc" th:if="${bookmark.description != null and !bookmark.description.isEmpty()}"
         th:text="${bookmark.description}">Description</div>
    <div class="bookmark-meta">
        <div class="bookmark-tags">
            <a th:each="tag : ${bookmark.tagNames}" th:href="@{'/tag/' + ${tag}}" class="tag-badge" th:text="${tag}">tag</a>
        </div>
        <div class="bookmark-stats">
            <span th:if="${bookmark.ownerUsername != null}" th:text="'by ' + ${bookmark.ownerUsername}"></span>
            <span th:if="${bookmark.folderName != null}" th:text="'Folder: ' + ${bookmark.folderName}"></span>
            <span th:text="'Views: ' + ${bookmark.accessCount}">Views: 0</span>
            <a th:href="@{'/bookmark/' + ${bookmark.id}}"
               style="color: var(--text-muted); text-decoration: none;"
               th:text="${bookmark.commentCount != null and bookmark.commentCount > 0} ? 'Comments: ' + ${bookmark.commentCount} : 'Comment'">Comment</a>
        </div>
    </div>
</div>

<!-- Pagination Fragment -->
<div th:fragment="pagination(page)" class="pagination" th:if="${page.totalPages > 1}">
    <a class="page-link" th:classappend="${page.first} ? 'disabled'"
       th:href="@{''(page=${page.number - 1})}">&laquo;</a>
    <th:block th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}">
        <a class="page-link" th:classappend="${i == page.number} ? 'active'"
           th:href="@{''(page=${i})}" th:text="${i + 1}">1</a>
    </th:block>
    <a class="page-link" th:classappend="${page.last} ? 'disabled'"
       th:href="@{''(page=${page.number + 1})}">&raquo;</a>
</div>

<!-- Post Compose Modal -->
<div th:fragment="postComposeModal" id="bookmarkModal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal post-compose-modal">
        <h3 id="modalTitle">Share a Story</h3>
        <form id="bookmarkForm" onsubmit="savePost(event)">
            <input type="hidden" id="bookmarkId"/>

            <div class="form-group">
                <label for="bmTitle">Title *</label>
                <input type="text" id="bmTitle" class="form-control" placeholder="Give your story a title" required/>
            </div>

            <!-- Location Section -->
            <div class="form-group">
                <label>Location <span style="font-size:0.75rem;color:var(--text-muted);">(click map to place marker)</span></label>
                <div id="composeMap" class="compose-map"></div>
                <input type="hidden" id="bmLatitude"/>
                <input type="hidden" id="bmLongitude"/>
                <input type="hidden" id="bmAddress" class="form-control" placeholder="Address or place name" style="margin-top:6px;"/>
                <input type="text" id="bmLocationSearch" class="form-control"
                       placeholder="Search address..." style="margin-top:6px;"/>
                <div id="composeSearchResults" class="compose-search-results" style="display:none;"></div>
            </div>

            <!-- Emoji Marker -->
            <div class="form-group">
                <label>Map Marker Emoji</label>
                <input type="hidden" id="bmMapEmoji"/>
                <div class="emoji-picker-row">
                    <button type="button" class="btn btn-outline emoji-picker-selected" id="emojiPickerBtn" onclick="toggleEmojiPicker()">&#128205;</button>
                    <button type="button" class="btn btn-sm btn-outline" onclick="clearEmojiSelection()">Clear</button>
                </div>
                <div id="emojiPickerPanel" class="emoji-picker-panel" style="display:none;"></div>
            </div>

            <!-- Photo Section -->
            <div class="form-group">
                <label>Photos <span style="font-size:0.75rem;color:var(--text-muted);">(max 4)</span></label>
                <div id="photoDropZone" class="photo-drop-zone" onclick="document.getElementById('photoFileInput').click()">
                    <p>Drop photos here or click to browse</p>
                    <input type="file" id="photoFileInput" accept="image/*" multiple style="display:none;" onchange="handlePhotoSelect(this.files)"/>
                </div>
                <div id="photoPreviewContainer" class="photo-preview-container"></div>
            </div>

            <!-- Caption -->
            <div class="form-group">
                <label for="bmCaption">Caption / Story</label>
                <textarea id="bmCaption" class="form-control" placeholder="Share your experience..." rows="3"></textarea>
            </div>

            <!-- URL (optional) -->
            <div class="form-group">
                <label for="bmUrl">Link <span style="font-size:0.75rem;color:var(--text-muted);">(optional)</span></label>
                <input type="url" id="bmUrl" class="form-control" placeholder="https://..."/>
            </div>

            <div class="form-group">
                <label for="bmDescription">Description</label>
                <textarea id="bmDescription" class="form-control" placeholder="Optional description"></textarea>
            </div>
            <div class="form-group">
                <label for="bmTags">Tags (comma separated)</label>
                <input type="text" id="bmTags" class="form-control" placeholder="travel, food, nature"/>
            </div>
            <div class="form-group">
                <label for="bmFolder">Folder</label>
                <select id="bmFolder" class="form-control">
                    <option value="">-- No Folder --</option>
                    <option th:each="f : ${folders}" th:value="${f.id}" th:text="${f.name}">Folder</option>
                </select>
            </div>
            <div class="form-group" style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" id="bmPrivate" style="width:auto;"/>
                <label for="bmPrivate" style="margin:0;font-size:0.85rem;color:var(--text-secondary);">Private (only visible to me)</label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Share</button>
            </div>
        </form>
    </div>
</div>

<!-- Folder Modal Fragment -->
<div th:fragment="folderModal" id="folderModal" class="modal-overlay" onclick="if(event.target===this)closeFolderModal()">
    <div class="modal">
        <h3>New Folder</h3>
        <form id="folderForm" onsubmit="saveFolder(event)">
            <div class="form-group">
                <label for="folderName">Folder Name *</label>
                <input type="text" id="folderName" class="form-control" placeholder="My Folder" required/>
            </div>
            <div class="form-group">
                <label for="folderParent">Parent Folder</label>
                <select id="folderParent" class="form-control">
                    <option value="">-- Root Level --</option>
                    <option th:each="f : ${folders}" th:value="${f.id}" th:text="${f.name}">Folder</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-outline" onclick="closeFolderModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Search Modal Fragment -->
<div th:fragment="searchModal" id="searchModal" class="modal-overlay" onclick="if(event.target===this)closeSearchModal()">
    <div class="search-modal">
        <div class="search-modal-input-row">
            <span style="font-size: 1.2rem;">&#128269;</span>
            <input type="text" id="globalSearchInput" class="form-control" placeholder="Search posts, tags, folders..."
                   oninput="onGlobalSearchInput()" autocomplete="off"/>
            <kbd class="search-kbd">ESC</kbd>
        </div>
        <div id="searchResults" class="search-results">
            <div class="search-results-empty" style="padding: 24px; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                Type to search...
            </div>
        </div>
    </div>
</div>

</html>
